$(document).ready(function(){if(document.querySelector(".movie-culture-list")){const t={config:{scrollInterval:300,scrollThreshold:200,itemsPerPage:12,jsonSrc:"https://api.chuanfang.org/trakt/movie",coverSrc:"https://image.tmdb.org/t/p/w116_and_h174_face",scrollRestoreTimeout:24*60*60*1e3},state:{currentPage:1,isLoading:false,dataEnded:false,loadedItemsCount:0,lastScrollPosition:0,restoredPosition:null,scrollTimer:null},elements:{cultureList:document.querySelector(".movie-culture-list"),loadingElement:document.getElementById("loading")},init(){this.setupScrollRestoreStyles();this.createScrollRestoreIndicator();this.setupEventListeners();this.loadInitialData()},setupScrollRestoreStyles(){const t=document.createElement("style");t.textContent=`
          .scroll-restore-indicator {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 24px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
          }
          
          .scroll-restore-indicator.visible {
            opacity: 1;
            visibility: visible;
          }
          
          .scroll-restore-indicator .loading-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #ffffff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
          }
          
          @keyframes spin {
            to { transform: rotate(360deg); }
          }
        `;document.head.appendChild(t)},createScrollRestoreIndicator(){const t=document.createElement("div");t.className="scroll-restore-indicator";t.innerHTML=`
          <div class="loading-spinner"></div>
          <span>正在恢复浏览位置...</span>
        `;document.body.appendChild(t);this.elements.scrollRestoreIndicator=t},setupEventListeners(){window.addEventListener("scroll",this.throttle(()=>{if(this.state.dataEnded||this.state.isLoading)return;const t=document.documentElement.scrollHeight-window.innerHeight-window.scrollY;if(t<=this.config.scrollThreshold){clearTimeout(this.state.scrollTimer);this.state.scrollTimer=setTimeout(()=>{this.loadMoreData()},this.config.scrollInterval)}this.debounce(()=>this.saveScrollPosition(),150)()},100));document.addEventListener("visibilitychange",()=>{if(document.visibilityState==="visible"){this.restoreScrollPosition()}});window.addEventListener("beforeunload",()=>{this.saveScrollPosition()})},debounce(e,i){let a;return(...t)=>{clearTimeout(a);a=setTimeout(()=>e.apply(this,t),i)}},throttle(e,i){let a;return(...t)=>{if(!a){e.apply(this,t);a=true;setTimeout(()=>a=false,i)}}},async loadInitialData(){const t=sessionStorage.getItem("movie_init_data");if(t){sessionStorage.removeItem("movie_init_data");await this.processInitialData(JSON.parse(t))}else{await this.fetchData(this.state.currentPage)}this.restoreScrollPosition()},async processInitialData(t){if(t["data"]["data"].length===0){this.state.dataEnded=true}else{await this.generateMovieElements(t)}},async loadMoreData(){if(this.state.isLoading||this.state.dataEnded)return;this.state.currentPage++;await this.fetchData(this.state.currentPage)},async fetchData(t){this.showLoading();this.state.isLoading=true;try{const e=await fetch(`${this.config.jsonSrc}?page=${t}&page_size=${this.config.itemsPerPage}`);const i=await e.json();if(i["data"]["data"].length===0){this.state.dataEnded=true}else{await this.generateMovieElements(i)}}catch(t){console.error("Error fetching movies:",t)}finally{this.hideLoading();this.state.isLoading=false}},showLoading(){this.elements.loadingElement.style.display="block"},hideLoading(){this.elements.loadingElement.style.display="none"},convertToStars(t){let e=parseFloat(t)/2;if(e>4.3)e=5;const i=parseInt(e);const a=e-i;const s=5-i-Math.ceil(a);return["★".repeat(i)+"☆".repeat(a),"☆".repeat(s)]},async generateMovieElements(t){const e=t["data"]["data"];const i=document.createDocumentFragment();e.forEach(t=>{const e=this.createMovieElement(t);i.appendChild(e);this.state.loadedItemsCount++});this.elements.cultureList.appendChild(i);this.initializeLazyLoading()},createMovieElement(t){const e=document.createElement("div");e.classList.add("media");if(t.share_link==="")e.style.opacity="0.5";e.dataset.movieId=t.movie_id;e.dataset.index=this.state.loadedItemsCount;const i=this.createMovieCover(t);const a=this.createMovieMeta(t);e.appendChild(i);e.appendChild(a);return e},createMovieCover(t){const e=document.createElement("div");e.classList.add("media-cover");const i=document.createElement("img");i.setAttribute("src",this.config.coverSrc+t.cover_image_url);i.setAttribute("data-src",this.config.coverSrc+t.cover_image_url);i.setAttribute("data-loaded","true");i.setAttribute("lazyload","");i.setAttribute("srcset","/img/loading.gif");const a=document.createElement("a");a.setAttribute("target","_blank");a.classList.add("media-cover-link");a.setAttribute("href",`/culture/movies/detail/?tmdb_id=${t.movie_id}`);a.appendChild(i);e.appendChild(a);return e},createMovieMeta(t){const e=document.createElement("div");e.classList.add("media-meta");const i=document.createElement("div");i.classList.add("media-meta-item","title");const a=document.createElement("a");a.classList.add("title-link");a.setAttribute("target","_blank");a.setAttribute("href",`/culture/movies/detail/?tmdb_id=${t.movie_id}`);a.textContent=t.movie_name;i.appendChild(a);const s=document.createElement("div");s.classList.add("media-meta-item");const o=document.createElement("span");o.classList.add("author");o.textContent=`${t.area} ${t.release_year}`;s.appendChild(o);const n=document.createElement("span");n.classList.add("star-score");const[r,l]=this.convertToStars(t.rating);n.textContent=r;const c=document.createElement("span");c.classList.add("grey-star");c.textContent=l;n.appendChild(c);s.appendChild(n);const d=document.createElement("div");d.classList.add("media-meta-item","intro");d.textContent=t.movie_description;e.appendChild(i);e.appendChild(s);e.appendChild(d);return e},initializeLazyLoading(){document.querySelectorAll("img[lazyload]").forEach(t=>{Fluid.utils.waitElementVisible(t,()=>{t.removeAttribute("srcset");t.removeAttribute("lazyload")},CONFIG.lazyload.offset_factor)})},saveScrollPosition(){const t={position:window.scrollY,timestamp:Date.now(),loadedItems:this.state.loadedItemsCount,currentPage:this.state.currentPage};localStorage.setItem(`movie_scroll_${window.location.pathname}`,JSON.stringify(t))},async restoreScrollPosition(){const t=localStorage.getItem(`movie_scroll_${window.location.pathname}`);if(!t)return;try{const e=JSON.parse(t);if(Date.now()-e.timestamp>this.config.scrollRestoreTimeout){localStorage.removeItem(`movie_scroll_${window.location.pathname}`);return}if(e.currentPage>this.state.currentPage){this.elements.scrollRestoreIndicator.classList.add("visible");while(this.state.currentPage<e.currentPage&&!this.state.dataEnded){await this.loadMoreData()}}requestAnimationFrame(()=>{window.scrollTo({top:e.position,behavior:"instant"});setTimeout(()=>{this.elements.scrollRestoreIndicator.classList.remove("visible")},500)})}catch(t){console.error("Error restoring scroll position:",t);localStorage.removeItem(`movie_scroll_${window.location.pathname}`)}},cleanupScrollData(){const t=Object.keys(localStorage);const e=t.filter(t=>t.startsWith("movie_scroll_"));const i=Date.now();e.forEach(e=>{try{const t=JSON.parse(localStorage.getItem(e));if(i-t.timestamp>this.config.scrollRestoreTimeout){localStorage.removeItem(e)}}catch(t){localStorage.removeItem(e)}})}};t.init();setInterval(()=>t.cleanupScrollData(),24*60*60*1e3)}});